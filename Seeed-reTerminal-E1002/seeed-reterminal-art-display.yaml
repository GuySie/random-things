####################################################
## Seeed reTerminal Art Display
##
## Configuration to use a Seeed reTerminal E1002 Spectra 6 color e-ink display as a digital art frame.
## By default, the display will wake up once every 6 hours to display a new random image.
## 
## HOW TO USE
##
## PREPARATION
## 01. Set substitutions for names, keys, passwords, etc.
## 02. Set substitution ha_www_url to the publicly accessible URL of your www folder, with trailing slash. This default should work for most people.
##     For more information, check: https://www.home-assistant.io/integrations/http/#hosting-files
## 03. If you want to store the images you will display in a subfolder, set substitution album_folder to the name of this folder and add a trailing slash. 
##     Change to "" if no subfolder is used.
## 04. Set substitution max_images to the maximum amount of images you want to use in the future without having to update this configuration again.
## 05. Create a helper boolean in Home Assistant that will control whether this frame goes into deep sleep. Set substitution ha_deep_sleep to this helper's entity name.
## 06. Set substitution deep_sleep_run to the amount of time the frame should stay awake. By default this is set to 1 minute, which is enough to load a random image.
## 07. Set substitution deep_sleep_duration to the amount of time the frame should sleep. By default this is set to 6 hours, so the frame refreshes 4 times each day.
## 08. Upload properly prepared PNG images to the (sub)folder you configured. Number them sequentially, starting at 1.png, followed by 2.png, etc.
##     This configuration assumes a continuous set of sequentially ascending numbered files, with no gaps.
##
## INSTALLATION
## 09. Set your deep sleep helper boolean to off, so you can configure the display after installation.
## 10. Install this configuration onto your Seeed reTerminal E1002 display.
## 11. Add the display to Home Assistant after it has been discovered.
## 12. In Home Assistant, set the "Total Images" number of this ESPHome device to the highest numbered image you have uploaded.
##     Update this number if you upload additional (sequentially-numbered) images.
##
## USAGE
## 13. Set your deep sleep helper boolean to on, so the display with automatically go through deep sleep cycles. Every time it wakes, it will load a random image.
## 14. Press the green button to wake the display out of deep sleep, and load a random image.
## 15. While the display is awake, press the white buttons on top of the display to go forward/backward sequentially through your images.
## 16. While the display is awake, set the "Current Image" number of this device in Home Assistant to go to that specific numbered image.
##
## To prepare images for use on this display, ensure they are:
## - In PNG format
## - In 800x480 pixel resolution
## - Dithered to the 6-color palette of the Spectra 6 e-ink panel in this display (the 6 colors are Black, White, Red, Green, Blue, Yellow)
##
## TIP: For best image quality, use the epdoptimize demo tool from paperlesspaper to dither your images.
##      It uses a Spectra 6-calibrated color palette while dithering for more realistic colors on the e-ink display.
##      https://paperlesspaper.de/en/blog/dither-eink-tool-open-source
##
## By Guy Sie (https://github.com/guysie)
## Based on configuration by Paul Krischer (https://github.com/SqyD) to use the Seeed reTerminal E1002 with the new epaper_spi component and LVGL
##
####################################################

substitutions:
  name: seeed-reterminal
  friendly_name: "Seeed reTerminal"
  project_name: "Guy Sie.reTerminal Art Display"
  project_version: "0.3.0"
  api_key: ""
  ota_password: ""
  ap_password: ""
  wifi_ssid: !secret wifi_ssid
  wifi_password: !secret wifi_password
  ha_www_url: "http://homeassistant.local:8123/local/"
  album_folder: "reterminal/"
  max_images: 1000
  ha_deep_sleep: "input_boolean.reterminal_deep_sleep"
  deep_sleep_run: "1min"
  deep_sleep_duration: "6h"

####################################################

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  project:
    name: ${project_name}
    version: ${project_version}
  on_boot:
# Enable battery voltage measurement
    - priority: 600
      then:
        - output.turn_on: bsp_battery_enable
# Load random image on boot (includes waking from deep sleep)
    - priority: -100
      then:
        - number.set:
            id: image_counter
            value: !lambda |-
              uint32_t random_value = esp_random();
              return (random_value % (int)id(total_images).state);

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: ${api_key}

ota:
  - platform: esphome
    password: ${ota_password}

wifi:
  ssid: ${wifi_ssid}
  password: ${wifi_password}
# Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Seeed-Reterminal"
    password: ${ap_password}

captive_portal:

http_request:


## Deep sleep configuration
# Comment out to disable deep sleep. This lets you use the green button as a control instead
deep_sleep:
  id: deep_sleep_1
  run_duration: ${deep_sleep_run}
  sleep_duration: ${deep_sleep_duration}
# Green button interrupts deep sleep
  wakeup_pin: GPIO3
  wakeup_pin_mode: INVERT_WAKEUP


## Hardware configuration (ESP, buttons, sensors, battery, buzzer, LED)
esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

psram:
  mode: octal

i2c:
  scl: GPIO20
  sda: GPIO19

binary_sensor:
# Left white button (back)
  - platform: gpio
    pin:
      number: GPIO5
      mode: INPUT_PULLUP
      inverted: true
    id: button_1
    name: "Button Left"
    disabled_by_default: true
    on_press:
      then:
        - if:
            condition:
              lambda: 'return (id(audiofeedback).state);'
            then:
              - light.turn_on:
                  id: buzzer
                  brightness: 25%
              - delay: 150ms
              - light.turn_off: buzzer
# If currently displayed image is the first one in the folder, don't go further back
        - if:
            condition:
              lambda: 'return id(image_counter).state == 1;'
            then:
              - logger.log: "Image counter already at minimum image count"
            else:
              - number.decrement:
                  id: image_counter
                  cycle: false

# Right white button (forward)
  - platform: gpio
    pin:
      number: GPIO4
      mode: INPUT_PULLUP
      inverted: true
    id: button_2
    name: "Button Right"
    disabled_by_default: true
    on_press:
      then:
        - if:
            condition:
              lambda: 'return (id(audiofeedback).state);'
            then:
              - light.turn_on:
                  id: buzzer
                  brightness: 25%
              - delay: 150ms
              - light.turn_off: buzzer
# If currently displayed image is the last one in the folder, don't go further forward
        - if:
            condition:
              lambda: 'return id(image_counter).state == id(total_images).state;'
            then:
              - logger.log: "Image counter already at total image count"
            else:
              - number.increment:
                  id: image_counter
                  cycle: false

## Green button (random)
# Uncomment to use green button for random image. You must disable deep sleep to do so.
#  - platform: gpio
#    pin:
#      number: GPIO3
#      mode: INPUT_PULLUP
#      inverted: true
#    id: button_3
#    name: "Button Green"
#    disabled_by_default: true
#    on_press:
#      then:
#        - if:
#            condition:
#              lambda: 'return (id(audiofeedback).state);'
#            then:
#              - light.turn_on:
#                  id: buzzer
#                  brightness: 25%
#              - delay: 150ms
#              - light.turn_off: buzzer
#        - number.set:
#            id: image_counter
#            value: !lambda |-
#              uint32_t random_value = esp_random();
#              return (random_value % (int)id(total_images).state);

sensor:
# Temperature and Relative Humidity sensor configuration
# Uncomment to provide temperature and humidity readings
#  - platform: sht4x
#    temperature:
#      name: "Temperature"
#      id: temp_sensor
#    humidity:
#      name: "Relative Humidity"
#      id: hum_sensor
# Battery voltage and Battery level sensor configuration
  - platform: adc
    pin: GPIO1
    name: "Battery Voltage"
    id: battery_voltage
    internal: true
    update_interval: 20s
    attenuation: 12db
    filters:
# Compensate for voltage divider
      - multiply: 2.0 
  - platform: template
    name: "Battery Level"
    id: battery_level
    entity_category: diagnostic
    unit_of_measurement: "%"
    icon: "mdi:battery"
    device_class: battery
    state_class: measurement
    lambda: 'return id(battery_voltage).state;'
    update_interval: 10s
    filters:
      - calibrate_linear:
          - 4.15 -> 100.0
          - 3.96 -> 90.0
          - 3.91 -> 80.0
          - 3.85 -> 70.0
          - 3.80 -> 60.0
          - 3.75 -> 50.0
          - 3.68 -> 40.0
          - 3.58 -> 30.0
          - 3.49 -> 20.0
          - 3.41 -> 10.0
          - 3.30 -> 5.0
          - 3.27 -> 0.0
      - clamp:
          min_value: 0
          max_value: 100

output:
# Green side LED GPIO configuration
  - platform: gpio
    pin: GPIO6
    id: led_output
    inverted: true
# Battery voltage measurement GPIO configuration
  - platform: gpio
    pin: GPIO21
    id: bsp_battery_enable
# Buzzer configuration (to control the buzzer pwm, pretend it's an LED light)
  - platform: ledc
    pin: GPIO45
    id: buzzer_pwm
# The frequency determines the pitch of the buzzer's sound
    frequency: 100Hz

light:
# Expose green side LED to Home Assistant
  - platform: binary
    name: "Onboard LED"
    output: led_output
    id: onboard_led
    icon: mdi:led-outline
    disabled_by_default: true
# Create a fake light entity to control the buzzer. The 'brightness' of the light controls the buzzer's volume
  - platform: monochromatic
    output: buzzer_pwm
    name: "Buzzer"
    id: buzzer
    icon: mdi:volume-high
    disabled_by_default: true
    default_transition_length: 0s


## E-ink display configuration (spi, display, lvgl)
spi:
  clk_pin: GPIO7
  mosi_pin: GPIO9

display:
  - platform: epaper_spi
    id: epaper_display
    model: 7.3in-spectra-e6
    cs_pin: GPIO10
    dc_pin: GPIO11
    reset_pin:
      number: GPIO12
      inverted: false
    busy_pin:
      number: GPIO13
      inverted: true
    update_interval: never
    auto_clear_enabled: false

lvgl:
  buffer_size: 12%
  pages:
    - id: main_page
      widgets:
        - image:
            align: CENTER
            id: art
            src: onlineimage


## Image variables configuration
number:
# Total number of images in the folder; must match highest number filename in the folder
  - platform: template
    name: "Total Images"
    id: total_images
    icon: mdi:camera-burst
    min_value: 1
    max_value: ${max_images}
    step: 1
    restore_value: true
    initial_value: 10
    optimistic: true
    mode: box
# Current image being displayed
  - platform: template
    name: "Current Image"
    id: image_counter
    icon: mdi:image-frame
    min_value: 1
    max_value: ${max_images}
    step: 1
    initial_value: 1
    optimistic: true
    mode: box
    on_value:
      then:
# If current image is set to a file that can not exist, instead set to the highest-numbered file that can exist
        - if:
            condition:
              lambda: 'return id(image_counter).state > id(total_images).state;'
            then:
              - number.set:
                  id: image_counter
                  value: !lambda 'return id(total_images).state;'
            else:
# URL of image to display is always updated here, this causes online_image to start downloading
              - online_image.set_url:
                  id: onlineimage
                  url: !lambda |-
                    char urlstring[254];
                    sprintf(urlstring, "${ha_www_url}${album_folder}%d%s", (int)id(image_counter).state, ".png");
                    return (urlstring);


## Online image configuration
online_image:
  - url: https://placehold.co/10x10/white/white/jpg
    id: onlineimage
    type: rgb565
    format: png
    resize: 800x480
# Display component is always updated here once online_image has finished downloading
    on_download_finished:
      - lvgl.image.update:
          id: art
          src: onlineimage
      - component.update: epaper_display


## Switch configuration
switch:
# Expose switch to let user turn on/off button feedback sounds
  - platform: template
    name: "Audio Feedback"
    id: audiofeedback
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
    lambda: return id(audiofeedback).state;
# Deep sleep toggle
  - platform: homeassistant
    id: allow_deepsleep 
    name: Deep sleep toggle
    entity_id: ${ha_deep_sleep}
    on_turn_on:
      - deep_sleep.allow: deep_sleep_1
    on_turn_off:
      - deep_sleep.prevent: deep_sleep_1
  - platform: restart
    name: "Device Restart"
  - platform: template
    name: "Random Image"
    id: randomimage
    optimistic: true
    lambda: return id(randomimage).state;
    on_turn_on:
      - number.set:
          id: image_counter
          value: !lambda |-
            uint32_t random_value = esp_random();
            return (random_value % (int)id(total_images).state);
      - switch.turn_off: randomimage
